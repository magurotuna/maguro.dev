---
import type { CollectionEntry } from "astro:content";
import { Icon } from "astro-icon/components";
import BaseLayout from "./BaseLayout.astro";
import TableOfContents from "../components/TableOfContents.astro";
import { slugifyTag } from "../utils/slugify";

interface Props {
  post: CollectionEntry<"blog">;
  headings: { depth: number; slug: string; text: string }[];
  readingTime: number;
}

const { post, headings, readingTime } = Astro.props;
const { title, date, tags, description } = post.data;

const formattedDate = date.toISOString().split("T")[0];
const slug = post.id;
const ogImage = `/og/${slug}.png`;

// Replace "maguro.dev" with zero-width space to prevent X from parsing it as a URL
const tweetTitle = title.replace(/maguro\.dev/g, "maguro\u200B.dev");

// Filter headings for ToC (h1, h2, and h3)
const tocHeadings = headings.filter((h) => h.depth >= 1 && h.depth <= 3);
---

<BaseLayout
  title={`${title} | maguro\u200B.dev`}
  description={description}
  ogImage={ogImage}
>
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">{title}</h1>
      <div class="post-meta">
        <time datetime={date.toISOString()}>{formattedDate}</time>
        <span class="reading-time">{readingTime}分で読めます</span>
        {
          tags.length > 0 && (
            <ul class="post-tags">
              {tags.map((tag) => (
                <li>
                  <a href={`/tags/${slugifyTag(tag)}/`} class="tag">
                    #{tag}
                  </a>
                </li>
              ))}
            </ul>
          )
        }
      </div>
    </header>

    {
      tocHeadings.length > 0 && (
        <aside class="toc-container" data-pagefind-ignore>
          <TableOfContents headings={tocHeadings} />
        </aside>
      )
    }

    <div class="post-content">
      <slot />
    </div>

    <footer class="post-footer">
      <div class="share-buttons">
        <a
          href={`https://x.com/intent/tweet?url=${encodeURIComponent(`https://maguro.dev/blog/${slug}/`)}&text=${encodeURIComponent(`${tweetTitle} | maguro\u200B.dev`)}`}
          target="_blank"
          rel="noopener noreferrer"
          class="share-button share-x"
          aria-label="Share on X"
        >
          <Icon name="simple-icons:x" size={18} />
        </a>
        <a
          href={`https://b.hatena.ne.jp/entry/s/maguro.dev/blog/${slug}/`}
          target="_blank"
          rel="noopener noreferrer"
          class="share-button share-hatena"
          aria-label="Hatena Bookmark"
        >
          <Icon name="simple-icons:hatenabookmark" size={18} />
        </a>
        <button
          type="button"
          class="share-button share-copy"
          data-url={`https://maguro.dev/blog/${slug}/`}
          aria-label="Copy link"
        >
          <Icon name="lucide:link" size={18} class="icon-link" />
          <Icon name="lucide:check" size={18} class="icon-check" />
          <span class="copy-tooltip">Copied!</span>
        </button>
      </div>
    </footer>
  </article>
</BaseLayout>

<style>
  .post {
    padding-top: var(--spacing-unit);
  }

  .post-header {
    margin-bottom: calc(var(--spacing-unit) * 2);
    padding-bottom: calc(var(--spacing-unit) * 1.5);
    border-bottom: 1px solid var(--color-border);
  }

  .post-title {
    font-size: 1.75rem;
    margin: 0 0 var(--spacing-unit) 0;
    line-height: 1.3;
  }

  .post-meta {
    display: flex;
    align-items: baseline;
    gap: var(--spacing-unit);
    flex-wrap: wrap;
    font-size: 0.9rem;
    color: var(--color-text-secondary);
  }

  .reading-time {
    color: var(--color-text-secondary);
  }

  .post-tags {
    display: flex;
    flex-wrap: wrap;
    gap: calc(var(--spacing-unit) * 0.5);
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .tag {
    display: inline-flex;
    align-items: center;
    font-size: 0.85rem;
    color: var(--color-accent);
    background-color: var(--color-bg-secondary);
    padding: 0.1em 0.5em;
    border-radius: 4px;
    white-space: nowrap;
  }

  .tag:hover {
    text-decoration: none;
    background-color: var(--color-border);
  }

  .toc-container {
    margin-bottom: calc(var(--spacing-unit) * 2);
  }

  .post-content {
    line-height: var(--line-height);
  }

  .post-content :global(h2) {
    font-size: 1.4rem;
    margin-top: calc(var(--spacing-unit) * 3);
  }

  .post-content :global(h3) {
    font-size: 1.2rem;
    margin-top: calc(var(--spacing-unit) * 2);
  }

  .post-content :global(img) {
    border-radius: 4px;
    margin: var(--spacing-unit) 0;
  }

  .post-content :global(a) {
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .post-content :global(.heading-anchor) {
    text-decoration-line: underline;
    text-decoration-style: dotted;
    text-underline-offset: 4px;
  }

  .post-content :global(.heading-anchor:hover) {
    text-decoration-style: solid;
  }

  .post-footer {
    margin-top: calc(var(--spacing-unit) * 3);
    padding-top: calc(var(--spacing-unit) * 1.5);
    border-top: 1px solid var(--color-border);
  }

  .share-buttons {
    display: flex;
    justify-content: center;
    gap: 1rem;
  }

  .share-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2.25rem;
    height: 2.25rem;
    background-color: transparent;
    border: 1.5px solid;
    border-radius: 50%;
    text-decoration: none;
    transition:
      background-color 0.2s,
      border-color 0.2s,
      color 0.2s,
      transform 0.15s;
    cursor: pointer;
  }

  .share-button:hover {
    transform: scale(1.1);
  }

  .share-button:active {
    transform: scale(0.95);
  }

  /* X - theme-aware */
  .share-x {
    color: var(--color-text);
    border-color: var(--color-text);
  }

  .share-x:hover {
    background-color: var(--color-text);
    color: var(--color-bg);
  }

  /* Hatena Bookmark - brand blue */
  .share-hatena {
    color: #00a4de;
    border-color: #00a4de;
  }

  .share-hatena:hover {
    background-color: #00a4de;
    color: #fff;
  }

  /* Copy link - accent color */
  .share-copy {
    color: var(--color-accent);
    border-color: var(--color-accent);
  }

  .share-copy:hover {
    background-color: var(--color-accent);
    color: var(--color-bg);
  }

  .share-copy.copied {
    background-color: var(--color-accent);
    color: var(--color-bg);
  }

  /* Icon toggling */
  .share-copy .icon-check {
    display: none;
  }

  .share-copy.copied .icon-link {
    display: none;
  }

  .share-copy.copied .icon-check {
    display: block;
  }

  /* Tooltip */
  .share-copy {
    position: relative;
  }

  .copy-tooltip {
    position: absolute;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    background-color: var(--color-text);
    color: var(--color-bg);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition:
      opacity 0.2s,
      visibility 0.2s;
  }

  .copy-tooltip::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-top-color: var(--color-text);
  }

  .share-copy.copied .copy-tooltip {
    opacity: 1;
    visibility: visible;
  }
</style>

<script>
  function showCopiedFeedback(button: Element) {
    button.classList.add("copied");
    setTimeout(() => button.classList.remove("copied"), 1500);
  }

  document.querySelectorAll(".share-copy").forEach((button) => {
    button.addEventListener("click", async () => {
      const url = button.getAttribute("data-url");
      if (!url) return;

      try {
        await navigator.clipboard.writeText(url);
        showCopiedFeedback(button);
      } catch {
        // Fallback for older browsers
        const textarea = document.createElement("textarea");
        textarea.value = url;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);
        showCopiedFeedback(button);
      }
    });
  });
</script>
