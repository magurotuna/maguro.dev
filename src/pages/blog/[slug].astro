---
import { getCollection, render } from "astro:content";
import PostLayout from "../../layouts/PostLayout.astro";

export async function getStaticPaths() {
  const posts = await getCollection(
    "blog",
    ({ data }) => !data.draft || import.meta.env.DEV,
  );
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await render(post);

// Calculate estimated reading minutes
// Strip non-prose content for more accurate reading time
const CHARS_PER_MINUTE_JA = 650;
const readableText = (post.body ?? "")
  // Remove fenced code blocks first
  .replace(/```[\s\S]*?```/g, "")
  // Remove inline code
  .replace(/`[^`]+`/g, "")
  // Convert markdown links to just their text: [text](url) â†’ text
  .replace(/\[([^\]]*)\]\([^)]+\)/g, "$1")
  // Remove HTML/MDX tags
  .replace(/<[^>]+>/g, "")
  // Remove footnote references [^1]
  .replace(/\[\^[^\]]+\]/g, "")
  // Remove footnote definitions [^1]: ...
  .replace(/^\[\^[^\]]+\]:.*$/gm, "")
  // Remove heading markers
  .replace(/^#+\s*/gm, "")
  // Collapse multiple newlines
  .replace(/\n{2,}/g, "\n");
const charCount = readableText.trim().length;
const readingTime = Math.max(1, Math.round(charCount / CHARS_PER_MINUTE_JA));
---

<PostLayout post={post} headings={headings} readingTime={readingTime}>
  <Content />
</PostLayout>
